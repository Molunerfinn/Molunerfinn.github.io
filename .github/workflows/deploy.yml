name: Build and Deploy

on:
  push:
    branches:
      - hexo
  workflow_dispatch:

env:
  GH_REF: github.com/Molunerfinn/Molunerfinn.github.io.git
  GH_TOKEN: ${{ secrets.GH_TOKEN }}
  ALGOLIA_ADMIN_API_KEY: ${{ secrets.ALGOLIA_ADMIN_API_KEY }}
  ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}
  ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
  ALGOLIA_INDEX_NAME: ${{ secrets.ALGOLIA_INDEX_NAME }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: Install Yarn 1.22
        run: npm install -g yarn@1.22.22

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build site
        run: yarn run build

      - name: Deploy to GitHub Pages repo
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "GH_TOKEN secret must be configured to deploy." >&2
            exit 1
          fi
          cd public
          git init
          git config user.name "Molunerfinn"
          git config user.email "marksz@teamsz.xyz"
          git add .
          git commit -m "Update docs"
          git push --force --quiet "https://${GH_TOKEN}@${GH_REF}" master:master
